Impact of severe weather events on the U.S. population health and economy
========================================================


<br>
## Synopsis

This detailed analysis has been performed to fulfill the requirements of the second peer assessment for the course [Reproducible Research][1] offered by the [Johns Hopkins University][2] on [Coursera][3]. In this project, we will explore and analyse the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

The main objectives of this research are as follows
 - To find out which type of weather events, indicated by the `EVTYPE` variable, are the most harmful with respect to the population health in the U.S.
 - To find out which type of weather events have the greatest economic consequences in the U.S.

The key takeway from our analysis was
 - `TORNADO` is the most devastating weather event affecting the poplation health.
 - `FLOOD` has been responsible for causing the maximum property damage.
 - `DROUGHT` has been responsible for causing the maximum crop damage.


<br>
## Data Processing

This section consists of the steps followed to setup our R environment, get the required data, clean and process it.


#### <u>Setting up required environment in R</u>

In the following code segment, we set the required global options and load the required packages in R.
```{r}

opts_chunk$set(cache=TRUE,echo=TRUE)
options(scipen=999,width=100)

library(ggplot2)
library(reshape2)
library(gridExtra)
library(pander)

```

<br>
#### <u>Setting the working directory</u>

Here we set the working directory as required, it can be changed according to your preference in your personal computer.
```{r}

setwd('E:/MOOCs/Coursera/Data Science - Specialization/Reproducible Research/Peer Assessment 2')



```

<br>
#### <u>Getting the required data</u>
We get the required data set by downloading it, in case it is not present in the working directory by using the following code segment.
```{r}

if (!file.exists("repdata-data-StormData.csv.bz2")) {
    download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", 
        destfile = "repdata-data-StormData.csv.bz2", method = "curl")
}

```

<br>
#### <u>Loading the data</u>

Next, we read the file using appropriate functions and load in the data into the `stormData` data frame using the following code segment. We then look closely at the data set. It contains `902297` observations, where each observation is a row and `37` variables denoted by the columns. 
```{r comment=NA}

stormData <- read.csv(bzfile("repdata-data-StormData.csv.bz2"), sep = ",", header = TRUE, stringsAsFactors = FALSE)
str(stormData)

```

<br>
#### <u>Subsetting the data</u>

Looking closely at the above data set details, we pick several variables which are of our interest, namely
```

 INJURIES   :   This indicates Event-related injuries
 FATALITIES :   This indicates Event-related fatalities
 PROPDMG    :   This indicates the property damage amount
 CROPDMG    :   Crop damage amount
 PROPDMGEXP :   Property damage units
 CROPDMGEXP :   Crop damage units
 
``` 

The above variables will be mainly used for the analysis based on the questions defined in our objective earlier. Next, we subset our `stormData` data frame to get a data frame `stormDataSubset` with the necessary variables, such that none of its rows i.e, observations have zero injuries or fatalities or damages. The code segment below shows the operations which were performed and the data set we obtain consists of `254633` rows of observations and `7` variables as the columns.
```{r comment=NA}

stormDataSubset <- subset(x = stormData, subset = INJURIES > 0 | FATALITIES > 0 | PROPDMG > 
    0 | CROPDMG > 0, select = c("EVTYPE", "FATALITIES", "INJURIES", "PROPDMG", 
    "PROPDMGEXP", "CROPDMG", "CROPDMGEXP"))
str(stormDataSubset)

```

<br>
#### <u>Transforming the data</u>

Now, we will start operating on the data and transforming it into required formats to answer the questions in our main objective. 

<br>
#### First Objective
In the following segment, we will perform necessary steps to answer the objective of finding out, which types of weather events are most harmful to the human health.

Looking closely at the variables, we notice that to answer this question, there are two variables of interest namely, `FATALITIES` and `INJURIES` which we will be looking into more closely.

Now, we aggregate the total injuries for each weather event type across the U.S. in the following code segment and subset the events, only for which the number of injuries is atleast `1`
```{r comment=NA}

totalInjuries <- aggregate(INJURIES ~ EVTYPE, data=stormDataSubset, FUN=sum)
totalInjuries <- totalInjuries[totalInjuries$INJURIES > 0,]
str(totalInjuries)

```


Next, we aggregate the total fatalities for each weather event type across the U.S. in the following code segment and subset the events, only for which the number of fatalities is atleast `1`
```{r comment=NA}

totalFatalities <- aggregate(FATALITIES ~ EVTYPE, data=stormDataSubset, FUN=sum)
totalFatalities <- totalFatalities[totalFatalities$FATALITIES > 0,]
str(totalFatalities)

```

<br>
#### Second Objective
In the next segment, we will perform necessary steps to answer the objective of finding out, which types of weather events have the greatest economic consequences.

Looking closely at the variables, we notice that to answer this question, there are two variables of interest namely, `PROPDMG` and `CROPDMG` which we will be looking into more closely.

Now, the variables, `PROPDMGEXP` and `CROPDMGEXP` have different values which we can observe from the following code segments.
For `PROPDMGEXP` we see the following exponent values, here we have decided to use the following strategy, from the variable descriptions in the codebook and some assumptions

```

 '-' or '+' or ""  -  Leave PROPDMG as it is
 '0' - '7'         -  Multiply PROPDMG by 1eN i.e, 10^N where N belongs to {0,2,3,4,5,6,7}
 'B'               -  Multiply PROPDMG by 1e9 i.e, 10^9
 'h' or 'H'        -  Multiply PROPDMG by 1e2 i.e, 100
 'K'               -  Multiply PROPDMG by 1e3 i.e, 1000
 'm' or 'M'        -  Multiply PROPDMG by 1e6 i.e, 10^6
 
```

We take the multipliers based on the distinct exponent labels shown in the code segment below.
```{r comment=NA}

t <- table(stormDataSubset$PROPDMGEXP)
names(t) <- c('""', '-',  '+', '0', '2', '3',	'4', '5', '6', '7', 'B', 'h', 'H', 'K', 'm', 'M')
pandoc.table(t, style = "grid", justify = 'left', caption = 'PROPDMGEXP label frequencies')

```

<br>
For `CROPDMGEXP` we see the following exponent values, here we have decided to use the following strategy, from the variable descriptions in the codebook and some assumptions

```

 '?' or ""  -  Leave CROPDMG as it is
 '0'        -  Multiply CROPDMG by 1eN i.e, 10^N where N belongs to {0}
 'B'        -  Multiply CROPDMG by 1e9 i.e, 10^9
 'k' or 'K' -  Multiply CROPDMG by 1e3 i.e, 1000
 'm' or 'M' -  Multiply CROPDMG by 1e6 i.e, 10^6
 
```

We take the multipliers based on the distinct exponent labels shown in the code segment below.
```{r comment=NA}

t <- table(stormDataSubset$CROPDMGEXP)
names(t) <- c('""', '?',  '0', 'B', 'k', 'K', 'm', 'M')
pandoc.table(t, style = "grid", justify = 'left', caption = 'CROPDMGEXP label frequencies')


```

<br>
Now we transform the values of `PROPDMGEXP` based on the key to proper numeric multipliers in the following code segment. 
```{r comment=NA}

multiplierKey <- c("-"=1, "+"=1, "0"=1e0, "2"=1e2, "3"=1e3, "4"=1e4, "5"=1e5, "6"=1e6, "7"=1e7, "B"=1e9, "h"=1e2, "H"=1e2, "K"=1e3, "m"=1e6, "M" = 1e6)

propdmgMultiplier <- multiplierKey[as.character(stormDataSubset$PROPDMGEXP)]

propdmgMultiplier[is.na(propdmgMultiplier)] <- 1

pandoc.table(table(propdmgMultiplier), style = "grid", justify = 'left', caption = 'Property damage multiplier value frequencies')

```

After getting the multiplier values above, we multiply it with the respective `PROPDMG` values to obtain the actual value of property damage caused by the different weather event types.
```{r comment=NA}

stormDataSubset$propertyDamage <- stormDataSubset$PROPDMG * propdmgMultiplier

propertyDamages <- aggregate(propertyDamage ~ EVTYPE, data=stormDataSubset, FUN=sum)

propertyDamages <- propertyDamages[propertyDamages$propertyDamage > 0, ]

str(propertyDamages)

```


<br>
Now we transform the values of `CROPDMGEXP` based on the key to proper numeric multipliers in the following code segment. 
```{r comment=NA}
multiplierKey <- c("?"=1, "0"=1e0, "B"=1e9, "k"=1e3, "K"=1e3, "m"=1e6, "M" = 1e6)

cropdmgMultiplier <- multiplierKey[as.character(stormDataSubset$CROPDMGEXP)]

cropdmgMultiplier[is.na(cropdmgMultiplier)] <- 1

pandoc.table(table(cropdmgMultiplier), style = "grid", justify = 'left', caption = 'Crop damage multiplier value frequencies')

```

After getting the multiplier values above, we multiply it with the respective `CROPDMG` values to obtain the actual value of property damage caused by the different weather event types.
```{r comment=NA}

stormDataSubset$cropDamage <- stormDataSubset$CROPDMG * cropdmgMultiplier

cropDamages <- aggregate(cropDamage ~ EVTYPE, data=stormDataSubset, FUN=sum)

cropDamages <- cropDamages[cropDamages$cropDamage > 0, ]

str(cropDamages)

```


<br>
## Analysis and Results

In this section, we will be analyzing the data we transformed and prepared in the previous section to answer the questions pertaining to our two main objectives. First, we will try to analyze the data to answer our first objective, which is to find out which weather event types affect population health the most. 

The following code segment shows us the top ten weather event types, which have been responsible for causing the most population injuries in the U.S. 
```{r comment=NA}

injuries <- totalInjuries[order(totalInjuries$INJURIES, decreasing = T), ][1:10, ]
row.names(injuries) <- NULL
pandoc.table(injuries, style = "grid", justify = 'left', caption = 'Top ten weather events causing most injuries')

```
From the above table, we see that `TORNADO` is the most harmful weather event causing maximum number of injuries.

<br>
The following code segment shows us the top ten weather event types, which have been responsible for causing the most population fatalities in the U.S. 
```{r comment=NA}

fatalities <- totalFatalities[order(totalFatalities$FATALITIES, decreasing = T), ][1:10, ]
row.names(fatalities) <- NULL
pandoc.table(fatalities, style = "grid", justify = 'left', caption = 'Top ten weather events causing most fatalities')

```
From the above table, we see that `TORNADO` is the most harmful weather event causing maximum number of injuries.

<br>
Now we combine the above two parameters, namely `INJURIES` and `FATALITIES` to also get the total damage caused by the different weather event types and sort them based on the total casualties which have been caused by the weather events and display the top ten most harmful weather event types on population health.
```{r comment=NA}

healthData <- aggregate(cbind(FATALITIES, INJURIES) ~ EVTYPE, data=stormDataSubset, FUN=sum)
TOTAL <- healthData$FATALITIES + healthData$INJURIES
healthData <- cbind(healthData, TOTAL)
healthData <- healthData[order(healthData$TOTAL, decreasing = T), ]
topTenHealth <- healthData[1:10,]
row.names(topTenHealth) <- NULL
pandoc.table(topTenHealth, style = "grid", justify = 'left', caption = 'Top ten weather events having harmful effects on population health')

```
From the above table, we see that the top three weather event types most harmful to the population health are, `TORNADO`, `EXCESSIVE HEAT` and `TSTM WIND`.

The following code segment, plots a figure depicting the top ten most harmful weather events to the U.S. population health.
<br>
```{r fig.width=18,fig.height=8}



plotHealth <- melt(topTenHealth[,c('EVTYPE','TOTAL','INJURIES','FATALITIES')],id.vars = 1)

ggplot(plotHealth,aes(x = reorder(EVTYPE, -value),y = value)) + 
       geom_bar(stat = "identity", aes(fill = variable),position = "dodge") + 
       theme(axis.text.x = element_text(angle = 45, hjust = 1),
             axis.line = element_line(size = 1, colour = "black", linetype = "dashed"),
             panel.background=element_rect(fill = "white"),
             panel.grid.major = element_line(colour = "black",linetype = "dotted"),
             panel.grid.minor = element_line(colour = "black",linetype = "dotted"), 
             panel.background=element_rect(fill = "white")) +
       xlab("Event Type") + 
       ylab("Humans affected") + 
       ggtitle("Figure 1: Top ten harmful weather event types affecting the US population health") +
       scale_fill_manual(name = "Damage Type", values = c("orangered4", "tan2","darkblue")
                    , labels = c("Total","Injuries","Fatalities"))

```

Looking at the above plot, we can deduce the following conclusions.
```

 The weather event types which are affecting poplation health most adversely are,
 
 TORNADO, EXCESSIVE HEAT, TSTM WIND, FLOOD and LIGHTNING.
 
 TORNADO            - Has the highest number of injuries and fatalities.
 EXCESSIVE HEAT     - Has the second highest number of injuries and fatalities.
 TSTM WIND & FLOOD  - Have almost equal number of injuries and fatalities.
 LIGHTNING          - Fifth highest in terms of injuries and fatalities. 
 HEAT & FLASH FLOOD - Have a high number of fatalities.
 
 These are the weather event types which should be paid attention to, with concerns
 to the population health.
 
```

<br>
Now, we will try to analyze the data to answer our second objective, which is to find out which weather event types affect the U.S. economy the most.

<br>
The following code segment shows us the top ten weather event types, which have been responsible for causing the most property damage in the U.S. 
```{r comment=NA}

propdmg <- propertyDamages[order(propertyDamages$propertyDamage, decreasing = T),][1:10, ]
row.names(propdmg) <- NULL
pandoc.table(propdmg, style = "grid", justify = 'left', caption = 'Top ten weather events causing most damage to property')

```
From the above table, we see that `FLOOD` is the most harmful weather event causing the maximum damage to property.

<br>
The following code segment shows us the top ten weather event types, which have been responsible for causing the most crop damage in the U.S. 
```{r comment=NA}

cropdmg <- cropDamages[order(cropDamages$cropDamage, decreasing = T),][1:10, ]
row.names(cropdmg) <- NULL
pandoc.table(cropdmg, style = "grid", justify = 'left', caption = 'Top ten weather events causing most damage to crops')

```
From the above table, we see that `DROUGHT` is the most harmful weather event causing the maximum damage to crops.

<br>
Now we combine the above two parameters, namely `propertyDamage` and `cropDamage` to also get the total damage caused by the different weather event types and sort them based on the total cost in dollars which have been caused due to damage, by the weather events and display the top ten most harmful weather event types on the economy.
```{r comment=NA}

economyData <- aggregate(cbind(propertyDamage, cropDamage) ~ EVTYPE, data=stormDataSubset, FUN=sum)
totalDamage <- economyData$propertyDamage + economyData$cropDamage
economyData <- cbind(economyData, totalDamage)
economyData <- economyData[order(economyData$totalDamage, decreasing = T), ]
topTenEconomy <- economyData[1:10,]
row.names(topTenEconomy) <- NULL
pandoc.table(topTenEconomy, style = "grid", justify = 'left', caption = 'Top ten weather events having harmful effects on economy')

```
From the above table, we see that the top three weather event types most harmful to the population health are, `FLOOD`, `HURRICANE/TYPHOON` and `TORNADO`.

The following code segment, plots a figure depicting the top ten most harmful weather events to the U.S. economy.
<br>
```{r fig.width=18,fig.height=8}

plotHealth <- melt(topTenEconomy[,c('EVTYPE','totalDamage','propertyDamage','cropDamage')],id.vars = 1)

ggplot(plotHealth,aes(x = reorder(EVTYPE, -value),y = value)) + 
       geom_bar(stat = "identity", aes(fill = variable),position = "dodge") + 
       theme(axis.text.x = element_text(angle = 45, hjust = 1),
             axis.line = element_line(size = 1, colour = "black", linetype = "dashed"),
             panel.background=element_rect(fill = "white"),
             panel.grid.major = element_line(colour = "black",linetype = "dotted"),
             panel.grid.minor = element_line(colour = "black",linetype = "dotted")) +
       xlab("Event Type") + 
       ylab("Damage cost in $") + 
       ggtitle("Figure 2: Top ten harmful weather event types affecting the US economy")+
       scale_fill_manual(name = "Damage Type", values = c("firebrick1", "dodgerblue3","chartreuse3")
                    , labels = c("Total Damage","Property Damage","Crop Damage"))

```

Looking at the above plot, we can deduce the following conclusions.
```

 The weather event types which are affecting poplation health most adversely are,
 
 FLOOD, HURRICANE/TYPHOON, TORNADO, STORM SURGE and HAIL.
 One should also not forget to look at DROUGHT in the figure.
 
 FLOOD               - Responsible for the most property and crop damange.
 HURRICANE/TYPHOON   - Second most harmful to the economy.
 TORNADO             - Third most harmful to the economy.
 STORM SURGE         - Comes after TORNADO in terms of damage to the economy. 
 HAIL & FLASH FLOOD  - Have almost equal harmful effects on the economy
 DROUGHT             - Responsible for causing maximum damage to crops.
 
 These are the weather event types which should be paid attention to, with concerns
 to the economy.
 
```
Finally, we will make a `panel plot` showing the top ten most harmful weather events for each of the following separately
 - INJURIES
 - FATALITIES
 - PROPERTY DAMAGE
 - CROP DAMAGE

The following code segment, creates a panel plot to accomplish the same.
```{r fig.width=18,fig.height=12}

plotFatalities <- melt(topTenHealth[,c('EVTYPE','FATALITIES')],id.vars = 1)
g1 <- ggplot(plotFatalities,aes(x = reorder(EVTYPE, -value),y = value)) + 
       geom_bar(stat = "identity", aes(fill = variable),position = "dodge") + 
       theme(axis.text.x = element_text(angle = 45, hjust = 1),
             axis.line = element_line(size = 1, colour = "black", linetype = "dashed"),
             panel.background=element_rect(fill = "white"),
             panel.grid.major = element_line(colour = "black",linetype = "dotted"),
             panel.grid.minor = element_line(colour = "black",linetype = "dotted"), 
             panel.background=element_rect(fill = "white")) +
       xlab("Event Type") + 
       ylab("Humans affected") + 
       ggtitle("Weather event types causing fatalities") +
       scale_fill_manual(name = "Damage Type", values = c("black")
                    , labels = c("Fatalities"))


plotInjuries <- melt(topTenHealth[,c('EVTYPE','INJURIES')],id.vars = 1)
g2 <- ggplot(plotInjuries,aes(x = reorder(EVTYPE, -value),y = value)) + 
       geom_bar(stat = "identity", aes(fill = variable),position = "dodge") + 
       theme(axis.text.x = element_text(angle = 45, hjust = 1),
             axis.line = element_line(size = 1, colour = "black", linetype = "dashed"),
             panel.background=element_rect(fill = "white"),
             panel.grid.major = element_line(colour = "black",linetype = "dotted"),
             panel.grid.minor = element_line(colour = "black",linetype = "dotted"), 
             panel.background=element_rect(fill = "white")) +
       xlab("Event Type") + 
       ylab("Humans affected") + 
       ggtitle("Weather event types causing injuries") +
       scale_fill_manual(name = "Damage Type", values = c("red")
                    , labels = c("Injuries"))


plotPropertyDamage <- melt(topTenEconomy[,c('EVTYPE','propertyDamage')],id.vars = 1)
g3 <- ggplot(plotPropertyDamage,aes(x = reorder(EVTYPE, -value),y = value)) + 
       geom_bar(stat = "identity", aes(fill = variable),position = "dodge") + 
       theme(axis.text.x = element_text(angle = 45, hjust = 1),
             axis.line = element_line(size = 1, colour = "black", linetype = "dashed"),
             panel.background=element_rect(fill = "white"),
             panel.grid.major = element_line(colour = "black",linetype = "dotted"),
             panel.grid.minor = element_line(colour = "black",linetype = "dotted"), 
             panel.background=element_rect(fill = "white")) +
       xlab("Event Type") + 
       ylab("Damage cost in $") + 
       ggtitle("Weather event types causing property damage") +
       scale_fill_manual(name = "Damage Type", values = c("blue4")
                    , labels = c("Property Damage"))


plotCropDamage <- melt(topTenEconomy[,c('EVTYPE','cropDamage')],id.vars = 1)
g4 <- ggplot(plotCropDamage,aes(x = reorder(EVTYPE, -value),y = value)) + 
       geom_bar(stat = "identity", aes(fill = variable),position = "dodge") + 
       theme(axis.text.x = element_text(angle = 45, hjust = 1),
             axis.line = element_line(size = 1, colour = "black", linetype = "dashed"),
             panel.background=element_rect(fill = "white"),
             panel.grid.major = element_line(colour = "black",linetype = "dotted"),
             panel.grid.minor = element_line(colour = "black",linetype = "dotted"), 
             panel.background=element_rect(fill = "white")) +
       xlab("Event Type") + 
       ylab("Damage cost in $") + 
       ggtitle("Weather event types causing crop damage") +
       scale_fill_manual(name = "Damage Type", values = c("darkgoldenrod2")
                    , labels = c("Crop Damage"))


grid.arrange(arrangeGrob(g1,g2,g3,g4, ncol=2, nrow=2), main=textGrob("Figure 3: Comparative plot of the top ten most harmful weather events",gp=gpar(fontsize=20,font=3)))

```
Looking at the above plot, we can deduce the following conclusions.
```

 FATALITIES       - Main cause of concern is TORNADO followed by EXCESSIVE HEAT and FLASH FLOOD.
 INJURIES         - Main cause of concern is TORNADO followed by TSTM WIND and FLOOD.
 PROPERTY DAMAGE  - Main cause of concern is FLOOD followed by HURRICANE/TYPHOON and TORNADO.
 CROP DAMAGE      - Main cause of concern is DROUGHT followed by FLOOD, RIVER FLOOD and ICE STORM.
 
```

<br>
## Conclusion

We analyzed the Storm Database provided by the U.S. National Oceanic and Atmospheric Administration and gained some interesting insights as to which weather event types pose a major threat to both the population health as well as the economy in the U.S. From our findings, we can conclude that major attention should be paid to `TORNADO`, `FLOOD` and `DROUGHT` followed by some other event types which have been mentioned in the above section.


[1]: https://www.coursera.org/course/repdata  "Reproducible Research"
[2]: https://www.coursera.org/jhu "Johns Hopkins University"
[3]: https://www.coursera.org/  "Coursera"